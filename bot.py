from telegram import InlineKeyboardButton, InlineKeyboardMarkup, Update
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes
import random
import logging

# Enable logging
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO
)
logger = logging.getLogger(__name__)

# Store users waiting for a match
waiting_users = []

# Inline Keyboard Handler
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [
            InlineKeyboardButton("Ø§Ø¨Ø¯Ø£ Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ", callback_data="videochat"),
            InlineKeyboardButton("Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©", callback_data="privacy"),
        ],
        [
            InlineKeyboardButton("Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©", callback_data="help"),
            InlineKeyboardButton("ÙƒÙŠÙÙŠØ© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…", callback_data="howto"),
        ],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await update.message.reply_text(
        "Ù…Ø±Ø­Ø¨Ù‹Ø§! Ø§Ø®ØªØ± Ø®ÙŠØ§Ø±Ù‹Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¯Ù†Ø§Ù‡:", reply_markup=reply_markup
    )

async def button_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    if query.data == "videochat":
        await start_video_chat(query, context)
    elif query.data == "privacy":
        await privacy_policy(query, context)
    elif query.data == "help":
        await help_ar(query, context)
    elif query.data == "howto":
        await how_to_use(query, context)

# Command Handlers
async def privacy_policy(update: Update, context: ContextTypes.DEFAULT_TYPE):
    privacy_message = (
        "ğŸ”’ **Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©**\n\n"
        "Ø®ØµÙˆØµÙŠØªÙƒ Ù…Ù‡Ù…Ø© Ù„Ù†Ø§. Ø¥Ù„ÙŠÙƒ ÙƒÙŠÙÙŠØ© ØªØ¹Ø§Ù…Ù„Ù†Ø§ Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ:\n\n"
        "1. Ù†Ø­Ù† Ù„Ø§ Ù†Ø®Ø²Ù† Ø£ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø´Ø®ØµÙŠØ©.\n"
        "2. Ù†Ø­Ù† Ù„Ø§ Ù†Ø´Ø§Ø±Ùƒ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø¹ Ø£Ø·Ø±Ø§Ù Ø«Ø§Ù„Ø«Ø©.\n"
        "3. Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ù…Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª Ø¢Ù…Ù†Ø©.\n\n"
        "Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù„Ø¯ÙŠÙƒ Ø£ÙŠ Ø£Ø³Ø¦Ù„Ø©ØŒ ÙÙ„Ø§ ØªØªØ±Ø¯Ø¯ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†Ø§."
    )
    await update.callback_query.edit_message_text(privacy_message)

async def help_ar(update: Update, context: ContextTypes.DEFAULT_TYPE):
    help_message = (
        "ğŸ›  **Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø±**\n\n"
        "Ø§Ø¨Ø¯Ø£ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª Ù…Ø¹ Ù‡Ø°Ù‡ Ø§Ù„Ø£ÙˆØ§Ù…Ø±:\n\n"
        "/start - Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„\n"
        "/privacy - Ø¹Ø±Ø¶ Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©\n"
        "/help - Ø¹Ø±Ø¶ Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©\n"
        "/videochat - Ø¨Ø¯Ø¡ Ø¯Ø±Ø¯Ø´Ø© ÙÙŠØ¯ÙŠÙˆ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©\n"
        "/howto - ÙƒÙŠÙÙŠØ© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª"
    )
    await update.callback_query.edit_message_text(help_message)

async def how_to_use(update: Update, context: ContextTypes.DEFAULT_TYPE):
    howto_message = (
        "ğŸ›  **ÙƒÙŠÙÙŠØ© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª**:\n\n"
        "1. Ø§Ù„Ø¨ÙˆØª Ø³ÙŠÙØªØ­ Ø§Ù„Ù…ØªØµÙØ­.\n"
        "2. Ø§Ø®ØªØ± Ù…ÙƒØ§Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ (Ø¬ÙˆØ§Ù„ Ø£Ùˆ ÙƒÙ…Ø¨ÙŠÙˆØªØ±).\n"
        "3. Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„ØªÙ†Ø²ÙŠÙ„ 'Jitsi'.\n"
        "4. ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©.\n"
        "5. Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ….\n"
        "6. Ø§Ø¶ØºØ· /videochat ÙÙŠ ÙƒÙ„ Ù…Ø±Ø© ØªØ±ÙŠØ¯ Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©."
    )
    await update.callback_query.edit_message_text(howto_message)

async def start_video_chat(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    user_name = update.effective_user.first_name

    # Add the user to the waiting list
    waiting_users.append((user_id, user_name))

    if len(waiting_users) >= 2:
        # Pair two random users
        user1, user2 = random.sample(waiting_users, 2)
        waiting_users.remove(user1)
        waiting_users.remove(user2)

        # Generate a unique video chat link using Jitsi Meet
        room_name = f"random-chat-{user1[0]}-{user2[0]}"
        video_chat_link = f"https://meet.jit.si/{room_name}?jitsi_meet_external_api_id=0&config.startWithVideoMuted=true&config.startWithAudioMuted=true"

        # Send the link to both users
        await context.bot.send_message(
            chat_id=user1[0],
            text=f"ğŸ¥ Ù„Ù‚Ø¯ ØªÙ… Ø¥Ù‚Ø±Ø§Ù†Ùƒ Ù…Ø¹ {user2[1]}! Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø¨Ø¯Ø¡ Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: {video_chat_link}\n\n"
                 "ğŸ’¡ **Ù…Ù„Ø§Ø­Ø¸Ø©**: Ø¥Ø°Ø§ Ù„Ù… ØªØ¹Ù…Ù„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø£Ùˆ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù† ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­."
        )
        await context.bot.send_message(
            chat_id=user2[0],
            text=f"ğŸ¥ Ù„Ù‚Ø¯ ØªÙ… Ø¥Ù‚Ø±Ø§Ù†Ùƒ Ù…Ø¹ {user1[1]}! Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø¨Ø¯Ø¡ Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ: {video_chat_link}\n\n"
                 "ğŸ’¡ **Ù…Ù„Ø§Ø­Ø¸Ø©**: Ø¥Ø°Ø§ Ù„Ù… ØªØ¹Ù…Ù„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø£Ùˆ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù† ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­."
        )
    else:
        await update.callback_query.edit_message_text("â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø± Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù…...")

# Error Handler
async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    logger.error(f"Error: {context.error}")

# Main Function
def main():
    # Use the provided bot token
    TOKEN = "7332555745:AAEGdPx1guRECMlIjlxTvms8Xx5EFDELelU"

    # Create the Application
    application = Application.builder().token(TOKEN).build()

    # Add handlers
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CallbackQueryHandler(button_callback))
    application.add_error_handler(error_handler)

    # Start the bot
    print("Bot is running...")
    application.run_polling()

if __name__ == "__main__":
    main()
